<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<ui:composition template="/templates/BasicTemplate.xhtml">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewAction action="#{searchNotificationBySaleController.initialize}" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<!-- 
		<script>
			function addMaintenance() {
				PF('stateButtom2').jq.click();
			}
		</script>
 -->
		<div class="title ui-widget-header ui-corner-all">
			<h:panelGrid style="margin:auto;">
		BUSCAR VENTAS PARA GESTIONAR NOTIFICACIONES
		</h:panelGrid>

		</div>

		<h:form id="form">


				<h:panelGrid style="margin:auto;text-align:center;">
					<p:messages id="messages" showDetail="true"></p:messages>
				</h:panelGrid>

				<h:panelGrid columns="3" style="margin:auto;text-align:center;">
					<h:panelGrid columns="2">
						<p:outputLabel value="Tipo de busqueda:"></p:outputLabel>
						<p:selectOneMenu id="searchType"
							value="#{searchNotificationBySaleController.searchTypeSelected}"
							required="true"
							requiredMessage="Debe seleccionar tipo de busqueda">
							<f:selectItem itemLabel="Seleccione..." itemValue="" />
							<f:selectItem itemLabel="Buscar por DNI responsable."
								itemValue="dni" />
							<f:selectItem itemLabel="Buscar por datos de venta."
								itemValue="saleData" />
							<p:ajax immediate="true" process=":form:searchType"
								listener="#{searchNotificationBySaleController.onChangeSearchType}"
								update=":form:searchTypeOut :form:messages"></p:ajax>
						</p:selectOneMenu>
					</h:panelGrid>
					<p:outputPanel id="searchTypeOut">
						<h:panelGrid columns="4"
							rendered="#{searchNotificationBySaleController.searchByDateSaleRendered}">

							<p:outputLabel value="F. Venta Desde:"></p:outputLabel>
							<p:calendar navigator="true"
								value="#{searchNotificationBySaleController.dateOfSaleStarted}"
								required="true"
								requiredMessage="Debe ingresar fecha venta desde:"
								pattern="dd-MM-yyyy"></p:calendar>

							<p:outputLabel value="F. Venta Hasta:"></p:outputLabel>
							<p:calendar navigator="true"
								value="#{searchNotificationBySaleController.dateOfSaleEnded}" required="true"
								requiredMessage="Debe ingresar fecha venta hasta:"
								pattern="dd-MM-yyyy"></p:calendar>

							<p:outputLabel value="F. Afiliacion"></p:outputLabel>
							<p:calendar navigator="true"
								value="#{searchNotificationBySaleController.affiliationDate}"
								pattern="dd-MM-yyyy"></p:calendar>


							<p:outputLabel value="Estado:"></p:outputLabel>
							<p:selectManyMenu id="state" 
								value="#{searchNotificationBySaleController.notificationStatesSelected}">
								<f:selectItems value="#{searchNotificationBySaleController.notificationStates}"></f:selectItems>
							</p:selectManyMenu>

						</h:panelGrid>


						<h:panelGrid columns="2"
							rendered="#{searchNotificationBySaleController.searchByDocumentNumberResponsibleRendered}">
							<p:outputLabel value="DNI RESP."></p:outputLabel>
							<p:inputText style="width: 120px;" required="true"
								requiredMessage="Debe ingresar DNI RESP."
								value="#{searchNotificationBySaleController.nuicResponsible}"></p:inputText>

						</h:panelGrid>

					</p:outputPanel>
				</h:panelGrid>
				
				<h:panelGrid columns="4" style="margin:auto;text-align:center;">
					<p:commandButton icon="ui-icon-search"
						actionListener="#{searchNotificationBySaleController.search}" value="Buscar"
						process="@form"
						update=":form:searchTypeOut :form:searchTable :form:saleId :form:salesCount :form:messages 
						:form:notificationsButtom :form:notificationButtom :form:dataButtom :form:payersButtom">
					</p:commandButton>

					<p:commandButton action="#{searchNotificationBySaleController.exportExcel}"
						value="Exportar a excel" process="@form" ajax="false">
					</p:commandButton>
					
					<p:commandButton immediate="true" icon="ui-icon-print"
						value="Imprimir cartas" ajax="false"
						actionListener="#{searchNotificationBySaleController.printNotifications}">
					</p:commandButton>
					
					<p:commandButton immediate="true" icon="ui-icon-plus"
						value="Crear masivamente notificaciones" 
						oncomplete="PF('notificationsDialog').show()"
						update=":formNotifications">
					</p:commandButton>
					

				</h:panelGrid>
			


				<h:panelGrid columns="1" style="width:100%;text-align:center;">

					<p:outputLabel id="salesCount"
						value="Se encontraron #{searchNotificationBySaleController.sales!=null?searchNotificationBySaleController.sales.size():'0'} ventas.">
					</p:outputLabel>
							
					<p:outputLabel id="saleId"
						value="Venta seleccionada: #{searchNotificationBySaleController.saleSelected!=null?searchNotificationBySaleController.saleSelected.code:''}">
					</p:outputLabel>
					
				</h:panelGrid>

				<h:panelGrid columns="4" style="width:100%; text-align:center;">

					<p:commandButton id="dataButtom" immediate="true"
						icon="ui-icon-pencil" value="Editar datos"
						update=":form:messages"
						actionListener="#{searchNotificationBySaleController.addPayer}"
						disabled="#{searchNotificationBySaleController.saleSelected==null}">
						<p:ajax event="dialogReturn" update=":form:searchTable"
							listener="#{searchNotificationBySaleController.afterAddPayer}" />
					</p:commandButton>
					
					<p:commandButton id="payersButtom"
						actionListener="#{searchNotificationBySaleController.showPayers}"
						icon="ui-icon-search" value="Ver actualizaciones de datos"
						oncomplete="PF('payersDialog').show()"
						update=":formPayer:payersDetail"
						disabled="#{searchNotificationBySaleController.saleSelected==null}">
					</p:commandButton>

					<p:commandButton id="notificationsButtom" immediate="true"
						actionListener="#{searchNotificationBySaleController.showNotifications}"
						icon="ui-icon-search" value="Ver notificaciones"
						update=":form:messages"
						disabled="#{searchNotificationBySaleController.saleSelected==null}">
					</p:commandButton>

					<p:commandButton id="notificationButtom" immediate="true"
						actionListener="#{searchNotificationBySaleController.addNotification}"
						icon="ui-icon-plus" value="Agregar notificaciÃ³n"
						update=":form:messages"
						disabled="#{searchNotificationBySaleController.saleSelected==null}">
						<p:ajax event="dialogReturn" update=":form:searchTable"
							listener="#{searchNotificationBySaleController.afterAddNotification}" />
					</p:commandButton>

				</h:panelGrid>



				<p:dataTable style="width:100%;" value="#{searchNotificationBySaleController.sales}" var="s"
					scrollable="true" scrollWidth="100%" paginator="true" rows="10"
					selectionMode="single"
					selection="#{searchNotificationBySaleController.saleSelected}" rowKey="#{s.id}"
					id="searchTable">

					<p:ajax event="rowSelect"
						update=":form:dataButtom :form:payersButtom :form:notificationsButtom :form:notificationButtom :form:saleId" />
					<p:ajax event="rowUnselect"
						update=":form:dataButtom :form:payersButtom :form:notificationsButtom :form:notificationButtom :form:saleId" />


					<p:column headerText="CODIGO" width="100">
						<h:outputText value="#{s.code}"></h:outputText>
					</p:column>

					<p:column headerText="TIPO DE DOCUMENTO" width="80">
						<h:outputText value="#{s.documentType}"></h:outputText>
					</p:column>

					<p:column headerText="NUIC RESP PAGO" width="80">
						<h:outputText value="#{s.payer.nuicResponsible}"></h:outputText>
					</p:column>

					<p:column headerText="AP PAT RESP PAGO" width="80">
						<h:outputText value="#{s.payer.lastnamePaternalResponsible}"></h:outputText>
					</p:column>

					<p:column headerText="AP MAT RESP PAGO" width="80">
						<h:outputText value="#{s.payer.lastnameMaternalResponsible}"></h:outputText>
					</p:column>

					<p:column headerText="NOMBRES RESP PAGO" width="80">
						<h:outputText value="#{s.payer.firstnameResponsible}"></h:outputText>
					</p:column>

					<p:column headerText="CORREO" width="120">
						<h:outputText value="#{s.payer.mail}"></h:outputText>
					</p:column>

					<p:column headerText="DEPARTAMENTO" width="80">
						<h:outputText value="#{s.payer.department}"></h:outputText>
					</p:column>

					<p:column headerText="PROVINCIA" width="80">
						<h:outputText value="#{s.payer.province}"></h:outputText>
					</p:column>

					<p:column headerText="DISTRITO" width="80">
						<h:outputText value="#{s.payer.district}"></h:outputText>
					</p:column>

					<p:column headerText="DIRECCION" width="80"
						style="white-space:nowrap;">
						<h:outputText value="#{s.payer.address}"></h:outputText>
					</p:column>

					<p:column headerText="FECHA DE VENTA" width="80">
						<h:outputText value="#{s.dateOfSale}" width="80">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</h:outputText>
					</p:column>

					<p:column headerText="ESTADO" width="80">
						<h:outputText value="#{s.saleState.state.name}"></h:outputText>
					</p:column>

					<p:column headerText="FECHA DE AFILIACION" width="80">
						<h:outputText value="#{s.affiliationDate}" width="80">
							<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss" />
						</h:outputText>
					</p:column>

					<p:column headerText="NOTIFICACIONES VIRTUALES" width="80">
						<h:outputText value="#{s.virtualNotifications}"></h:outputText>
					</p:column>

					<p:column headerText="NOTIFICACIONES FÃSICAS" width="80">
						<h:outputText value="#{s.physicalNotifications}"></h:outputText>
					</p:column>

					<p:column headerText="TIPO" width="80">
						<h:outputText value="#{s.notification.type.name}"></h:outputText>
					</p:column>

					<p:column headerText="ESTADO" width="80">
						<h:outputText value="#{s.notification.state.name}"></h:outputText>
					</p:column>

					<p:column headerText="FECHA DE ENVÃO" width="80">
						<h:outputText value="#{s.notification.sendingAt}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</h:outputText>
					</p:column>
					
					<p:column headerText="FECHA DE RESPUESTA" width="80">
						<h:outputText value="#{s.notification.answeringAt}">
							<f:convertDateTime pattern="dd/MM/yyyy" />
						</h:outputText>
					</p:column>
					
					<p:column headerText="NÃMERO DE ORDEN" width="80">
						<h:outputText value="#{s.notification.orderNumber}">
						</h:outputText>
					</p:column>
					
					<p:column headerText="NÃMERO CORRELATIVO" width="80">
						<h:outputText value="#{s.notification.correlativeNumber}">
						</h:outputText>
					</p:column>



				</p:dataTable>


		</h:form>

		

		<p:dialog header="Notificaciones" widgetVar="notificationsDialog"
			showEffect="fade" hideEffect="fade" width="400" height="200">
			<h:form id="formNotification">
				<p:outputPanel id="notificationsDetail" style="text-align:center;">

					<h:panelGrid style="margin:auto;">

						<p:dataTable value="#{searchNotificationBySaleController.notifications}" var="n"
							paginator="true" rows="5" id="notificationsTable">

							<p:column headerText="TIPO" width="100">
								<h:outputText value="#{n.type.name}"></h:outputText>
							</p:column>

							<p:column headerText="ESTADO" width="100">
								<h:outputText value="#{n.state.name}"></h:outputText>
							</p:column>

							<p:column headerText="FECHA ENVÃO" width="80">
								<h:outputText value="#{n.sendingAt}">
									<f:convertDateTime pattern="dd/MM/yyyy " />
								</h:outputText>
							</p:column>

							<p:column headerText="FECHA RESPUESTA" width="80">
								<h:outputText value="#{n.answeringAt}">
									<f:convertDateTime pattern="dd/MM/yyyy" />
								</h:outputText>
							</p:column>

							<p:column headerText="FECHA CREACIÃN" width="80">
								<h:outputText value="#{n.createdAt}">
									<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
								</h:outputText>
							</p:column>

							<p:column headerText="USUARIO CREACIÃN" width="80">
								<h:outputText value="#{n.createdBy.username}"></h:outputText>
							</p:column>




						</p:dataTable>

					</h:panelGrid>
				</p:outputPanel>
			</h:form>
		</p:dialog>
		
		
		<p:dialog header="Actualizaciones" widgetVar="payersDialog"
			showEffect="fade" hideEffect="fade" width="800" height="200">
			<h:form id="formPayer">
				<p:outputPanel id="payersDetail" style="text-align:center;">

					<h:panelGrid style="margin:auto;">

						<p:dataTable value="#{searchNotificationBySaleController.payers}" var="n"
							paginator="true" rows="5" id="payersTable">
							
							<p:column headerText="Nuic" width="100">
								<h:outputText value="#{n.nuicResponsible}"></h:outputText>
							</p:column>

							<p:column headerText="Nombres" width="100">
								<h:outputText value="#{n.firstnameResponsible}"></h:outputText>
							</p:column>

							<p:column headerText="Apellido Paterno" width="80">
								<h:outputText value="#{n.lastnamePaternalResponsible}">
								</h:outputText>
							</p:column>

							<p:column headerText="Apellido Materno" width="80">
								<h:outputText value="#{n.lastnameMaternalResponsible}">
								</h:outputText>
							</p:column>

							<p:column headerText="Correo" width="80">
								<h:outputText value="#{n.mail}">
								</h:outputText>
							</p:column>

							<p:column headerText="DirecciÃ³n" width="80">
								<h:outputText value="#{n.address}"></h:outputText>
							</p:column>
							
							<p:column headerText="Provincia" width="80">
								<h:outputText value="#{n.province}"></h:outputText>
							</p:column>
							
							<p:column headerText="Departamento" width="80">
								<h:outputText value="#{n.department}"></h:outputText>
							</p:column>
							
							<p:column headerText="Distrito" width="80">
								<h:outputText value="#{n.district}"></h:outputText>
							</p:column>
							
							<p:column headerText="FECHA CREACIÃN" width="80">
								<h:outputText value="#{n.createdAt}">
									<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
								</h:outputText>
							</p:column>

							<p:column headerText="USUARIO CREACIÃN" width="80">
								<h:outputText value="#{n.createdBy.username}"></h:outputText>
							</p:column>




						</p:dataTable>

					</h:panelGrid>
				</p:outputPanel>
			</h:form>
		</p:dialog>


		<p:dialog header="Password Supervisor" widgetVar="passSuperDialog"
			showEffect="fade" hideEffect="fade" width="800" height="200">
			<h:form id="formPassSuper">
				<h:panelGrid style="margin:auto;">

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:messages id="messagesPassSuper"></p:messages>
					</h:panelGrid>

					<h:panelGrid columns="2">

						<p:outputLabel value="Password supervisor"></p:outputLabel>
						<p:password required="true"
							requiredMessage="Debe ingresar password supervisor"
							value="#{searchNotificationBySaleController.passwordSupervisor}"></p:password>

					</h:panelGrid>

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:commandButton actionListener="#{searchNotificationBySaleController.validate}"
							update=":formPassSuper:messagesPassSuper" value="Aceptar">
							<p:ajax event="dialogReturn" update=":form:searchTable"
								listener="#{searchNotificationBySaleController.afterAddMaintenance}" />
						</p:commandButton>
					</h:panelGrid>
				</h:panelGrid>
			</h:form>

		</p:dialog>

	<p:dialog header="Crear Notificaciones"
			widgetVar="notificationsDialog" showEffect="fade" hideEffect="fade"
			width="800" height="200">
			<h:form id="formNotifications">
				<h:panelGrid style="margin:auto;">

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:messages  id="messagesNotifications" showDetail="true"></p:messages>
					</h:panelGrid>

					<h:panelGrid columns="2">

						<p:outputLabel value="Ingrese fecha de envÃ­o"></p:outputLabel>
						<p:calendar required="true" pattern="dd/MM/yyyy" navigator="true"
							requiredMessage="Debe ingresar fecha de envÃ­o"
							value="#{searchNotificationBySaleController.sendingAt}"></p:calendar>

					</h:panelGrid>

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:commandButton actionListener="#{searchNotificationBySaleController.createNotifications}"
							update=":formNotifications:messagesNotifications" value="Crear masivamente notificaciones">
						</p:commandButton>
					</h:panelGrid>
				</h:panelGrid>
			</h:form>

		</p:dialog>



	</ui:define>

</ui:composition>
</html>
