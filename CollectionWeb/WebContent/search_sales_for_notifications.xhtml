<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui">

<ui:composition template="/templates/BasicTemplate.xhtml">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewAction
				action="#{searchSalesForNotificationsController.initialize}" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<!-- 
		<script>
			function addMaintenance() {
				PF('stateButtom2').jq.click();
			}
		</script>
 -->
		<div class="title ui-widget-header ui-corner-all">
			<h:panelGrid style="margin:auto;">
		BUSCAR VENTAS PARA GESTIONAR NOTIFICACIONES
		</h:panelGrid>

		</div>

		<h:form id="form">


			<h:panelGrid style="margin:auto;text-align:center;">
				<p:messages id="messages" showDetail="true"></p:messages>
			</h:panelGrid>

			<h:panelGrid columns="2" style="margin:auto;text-align:center;">
				<p:outputLabel value="Tipo de búsqueda:"></p:outputLabel>
				<p:selectOneMenu id="searchType"
					value="#{searchSalesForNotificationsController.searchTypeSelected}"
					required="true" requiredMessage="Debe seleccionar tipo de búsqueda">
					<f:selectItem itemLabel="Seleccione..." itemValue="" />
					<f:selectItem itemLabel="Buscar por NUIC responsable."
						itemValue="dni" />
					<f:selectItem itemLabel="Buscar por datos de venta."
						itemValue="saleData" />
					<p:ajax immediate="true" process=":form:searchType"
						listener="#{searchSalesForNotificationsController.onChangeSearchType}"
						update=":form:searchTypeOut :form:messages"></p:ajax>
				</p:selectOneMenu>
			</h:panelGrid>
			<p:outputPanel id="searchTypeOut">
				<h:panelGrid columns="8" style="margin:auto;text-align:center;"
					rendered="#{searchSalesForNotificationsController.searchByDateSaleRendered}">


						<p:outputLabel value="Fecha venta desde:"></p:outputLabel>
						<p:calendar navigator="true"
							value="#{searchSalesForNotificationsController.dateOfSaleStarted}"
							required="true"
							requiredMessage="Debe ingresar fecha venta desde:"
							pattern="dd-MM-yyyy"></p:calendar>

						<p:outputLabel value="Fecha venta hasta:"></p:outputLabel>
						<p:calendar navigator="true"
							value="#{searchSalesForNotificationsController.dateOfSaleEnded}"
							required="true"
							requiredMessage="Debe ingresar fecha venta hasta:"
							pattern="dd-MM-yyyy"></p:calendar>

						
						<p:outputLabel value="Banco"></p:outputLabel>
						<p:selectOneMenu id="bank"
							value="#{searchSalesForNotificationsController.bankSelected}">
							<f:selectItem itemLabel="Seleccione..." itemValue="" />
							<f:selectItems
								value="#{searchSalesForNotificationsController.banks}"></f:selectItems>
						</p:selectOneMenu>

						<p:outputLabel value="Estado venta:"></p:outputLabel>
						<p:selectOneMenu id="saleState"
							value="#{searchSalesForNotificationsController.saleStateSelected}">
							<f:selectItems
								value="#{searchSalesForNotificationsController.saleStates}"></f:selectItems>
						</p:selectOneMenu>

						<p:outputLabel value="Fecha envío notificación"></p:outputLabel>
						<p:calendar navigator="true"
							value="#{searchSalesForNotificationsController.sendingDate}"
							pattern="dd-MM-yyyy"></p:calendar>

						<p:outputLabel value="Fecha afiliación"></p:outputLabel>
						<p:calendar navigator="true"
							value="#{searchSalesForNotificationsController.affiliationDate}"
							pattern="dd-MM-yyyy"></p:calendar>

						<p:outputLabel value="Tipo notificación"></p:outputLabel>
						<p:selectOneMenu id="notificationType"
							value="#{searchSalesForNotificationsController.notificationTypeSelected}">
							<f:selectItem itemLabel="Seleccione..." itemValue="" />
							<f:selectItems
								value="#{searchSalesForNotificationsController.notificationTypes}"></f:selectItems>
						</p:selectOneMenu>
						
						<p:outputLabel value="Estado notificación:"></p:outputLabel>
						<p:selectManyMenu id="notificationState"
							value="#{searchSalesForNotificationsController.notificationStatesSelected}">
							<f:selectItems
								value="#{searchSalesForNotificationsController.notificationStates}"></f:selectItems>
						</p:selectManyMenu>

				</h:panelGrid>


				<h:panelGrid columns="2" style="margin:auto;text-align:center;"
					rendered="#{searchSalesForNotificationsController.searchByDocumentNumberResponsibleRendered}">
					<p:outputLabel value="NUIC responsable"></p:outputLabel>
					<p:inputText style="width: 120px;" required="true"
						requiredMessage="Debe ingresar NUIC Responsable"
						value="#{searchSalesForNotificationsController.nuicResponsible}"></p:inputText>

				</h:panelGrid>

			</p:outputPanel>


			<h:panelGrid columns="5" style="margin:auto;text-align:center;">
				<p:commandButton icon="ui-icon-search"
					actionListener="#{searchSalesForNotificationsController.search}"
					value="Buscar" process="@form"
					update=":form:searchTypeOut :form:searchTable :form:saleId :form:salesCount :form:messages 
						:form:notificationsButtom :form:notificationButtom :form:dataButtom :form:payersButtom">
				</p:commandButton>

				<p:commandButton
					action="#{searchSalesForNotificationsController.exportExcel}"
					value="Exportar a excel" process="@form" ajax="false">
				</p:commandButton>

				<p:commandButton immediate="true" icon="ui-icon-print"
					value="Imprimir cartas" ajax="false"
					actionListener="#{searchSalesForNotificationsController.printLetters}">
				</p:commandButton>

				<p:commandButton immediate="true" icon="ui-icon-plus"
					value="Crear notificaciones físicas"
					oncomplete="PF('notificationsDialog').show()"
					update=":formNotifications">
				</p:commandButton>
				
				<p:commandButton immediate="true" icon="ui-icon-plus"
					value="Crear notificaciones virtuales"
					oncomplete="PF('notificationsDialog').show()"
					update=":formNotifications">
				</p:commandButton>


			</h:panelGrid>



			<h:panelGrid columns="1" style="width:100%;text-align:center;">

				<p:outputLabel id="salesCount"
					value="Se encontraron #{searchSalesForNotificationsController.sales!=null?searchSalesForNotificationsController.sales.size():'0'} ventas.">
				</p:outputLabel>

				<p:outputLabel id="saleId"
					value="Venta seleccionada: #{searchSalesForNotificationsController.saleSelected!=null?searchSalesForNotificationsController.saleSelected.code:''}">
				</p:outputLabel>

			</h:panelGrid>

			<h:panelGrid columns="4" style="width:100%; text-align:center;">

				<p:commandButton id="dataButtom" immediate="true"
					icon="ui-icon-pencil" value="Editar datos" update=":form:messages"
					actionListener="#{searchSalesForNotificationsController.addPayer}"
					disabled="#{searchSalesForNotificationsController.saleSelected==null}">
					<p:ajax event="dialogReturn" update=":form:searchTable"
						listener="#{searchSalesForNotificationsController.afterAddPayer}" />
				</p:commandButton>

				<p:commandButton id="payersButtom"
					actionListener="#{searchSalesForNotificationsController.showPayers}"
					icon="ui-icon-search" value="Ver actualizaciones de datos"
					oncomplete="PF('payersDialog').show()"
					update=":formPayer:payersDetail"
					disabled="#{searchSalesForNotificationsController.saleSelected==null}">
				</p:commandButton>

				<p:commandButton id="notificationsButtom" immediate="true"
					actionListener="#{searchSalesForNotificationsController.showNotifications}"
					icon="ui-icon-search" value="Ver notificaciones"
					update=":form:messages"
					disabled="#{searchSalesForNotificationsController.saleSelected==null}">
				</p:commandButton>

				<p:commandButton id="notificationButtom" immediate="true"
					actionListener="#{searchSalesForNotificationsController.addNotification}"
					icon="ui-icon-plus" value="Agregar notificación"
					update=":form:messages"
					disabled="#{searchSalesForNotificationsController.saleSelected==null}">
					<p:ajax event="dialogReturn" update=":form:searchTable"
						listener="#{searchSalesForNotificationsController.afterAddNotification}" />
				</p:commandButton>

			</h:panelGrid>



			<p:dataTable style="width:100%;"
				value="#{searchSalesForNotificationsController.sales}" var="s"
				scrollable="true" scrollWidth="100%" paginator="true" rows="10"
				selectionMode="single"
				selection="#{searchSalesForNotificationsController.saleSelected}"
				rowKey="#{s.id}" id="searchTable">

				<p:ajax event="rowSelect"
					update=":form:dataButtom :form:payersButtom :form:notificationsButtom :form:notificationButtom :form:saleId" />
				<p:ajax event="rowUnselect"
					update=":form:dataButtom :form:payersButtom :form:notificationsButtom :form:notificationButtom :form:saleId" />


				<p:column headerText="Código único venta" width="100">
					<h:outputText value="#{s.code}"></h:outputText>
				</p:column>

				<p:column headerText="Tipo documento responsable" width="80">
					<h:outputText value="#{s.documentType}"></h:outputText>
				</p:column>

				<p:column headerText="NUIC responsable" width="80">
					<h:outputText value="#{s.payer.nuicResponsible}"></h:outputText>
				</p:column>

				<p:column headerText="Apellido paterno responsable" width="80">
					<h:outputText value="#{s.payer.lastnamePaternalResponsible}"></h:outputText>
				</p:column>

				<p:column headerText="Apellido materno responsable" width="80">
					<h:outputText value="#{s.payer.lastnameMaternalResponsible}"></h:outputText>
				</p:column>

				<p:column headerText="Nombres responsable" width="80">
					<h:outputText value="#{s.payer.firstnameResponsible}"></h:outputText>
				</p:column>

				<p:column headerText="Correo" width="120">
					<h:outputText value="#{s.payer.mail}"></h:outputText>
				</p:column>

				<p:column headerText="Departamento" width="80">
					<h:outputText value="#{s.payer.department}"></h:outputText>
				</p:column>

				<p:column headerText="Provincia" width="80">
					<h:outputText value="#{s.payer.province}"></h:outputText>
				</p:column>

				<p:column headerText="Distrito" width="80">
					<h:outputText value="#{s.payer.district}"></h:outputText>
				</p:column>

				<p:column headerText="Dirección" width="80"
					style="white-space:nowrap;">
					<h:outputText value="#{s.payer.address}"></h:outputText>
				</p:column>

				<p:column headerText="Fecha venta" width="80">
					<h:outputText value="#{s.dateOfSale}" width="80">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>

				<p:column headerText="Estado venta" width="80">
					<h:outputText value="#{s.saleState.state.name}"></h:outputText>
				</p:column>
				
				<p:column headerText="Banco" width="80">
					<h:outputText value="#{s.commerce.bank.name}"></h:outputText>
				</p:column>

				<p:column headerText="Fecha afiliación" width="80">
					<h:outputText value="#{s.affiliationDate}" width="80">
						<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss" />
					</h:outputText>
				</p:column>

				<p:column headerText="Notificaciones virtuales" width="80">
					<h:outputText value="#{s.virtualNotifications}"></h:outputText>
				</p:column>

				<p:column headerText="Notificaciones físicas" width="80">
					<h:outputText value="#{s.physicalNotifications}"></h:outputText>
				</p:column>

				<p:column headerText="Tipo notificación" width="80">
					<h:outputText value="#{s.notification.type.name}"></h:outputText>
				</p:column>

				<p:column headerText="Estado Notificación" width="80">
					<h:outputText value="#{s.notification.state.name}"></h:outputText>
				</p:column>

				<p:column headerText="Fecha envío notificación" width="80">
					<h:outputText value="#{s.notification.sendingAt}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>

				<p:column headerText="Fecha respuesta notificación" width="80">
					<h:outputText value="#{s.notification.answeringAt}">
						<f:convertDateTime pattern="dd/MM/yyyy" />
					</h:outputText>
				</p:column>

				<p:column headerText="Número orden notificación" width="80">
					<h:outputText value="#{s.notification.orderNumber}">
					</h:outputText>
				</p:column>

				<p:column headerText="Número correlativo notificación" width="80">
					<h:outputText value="#{s.notification.correlativeNumber}">
					</h:outputText>
				</p:column>



			</p:dataTable>


		</h:form>



		<p:dialog header="Notificaciones" widgetVar="notificationsDialog"
			showEffect="fade" hideEffect="fade" width="400" height="200">
			<h:form id="formNotification">
				<p:outputPanel id="notificationsDetail" style="text-align:center;">

					<h:panelGrid style="margin:auto;">

						<p:dataTable
							value="#{searchSalesForNotificationsController.notifications}"
							var="n" paginator="true" rows="5" id="notificationsTable">

							<p:column headerText="TIPO" width="100">
								<h:outputText value="#{n.type.name}"></h:outputText>
							</p:column>

							<p:column headerText="ESTADO" width="100">
								<h:outputText value="#{n.state.name}"></h:outputText>
							</p:column>

							<p:column headerText="FECHA ENVÍO" width="80">
								<h:outputText value="#{n.sendingAt}">
									<f:convertDateTime pattern="dd/MM/yyyy " />
								</h:outputText>
							</p:column>

							<p:column headerText="FECHA RESPUESTA" width="80">
								<h:outputText value="#{n.answeringAt}">
									<f:convertDateTime pattern="dd/MM/yyyy" />
								</h:outputText>
							</p:column>

							<p:column headerText="FECHA CREACIÓN" width="80">
								<h:outputText value="#{n.createdAt}">
									<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
								</h:outputText>
							</p:column>

							<p:column headerText="USUARIO CREACIÓN" width="80">
								<h:outputText value="#{n.createdBy.username}"></h:outputText>
							</p:column>




						</p:dataTable>

					</h:panelGrid>
				</p:outputPanel>
			</h:form>
		</p:dialog>


		<p:dialog header="Actualizaciones" widgetVar="payersDialog"
			showEffect="fade" hideEffect="fade" width="800" height="200">
			<h:form id="formPayer">
				<p:outputPanel id="payersDetail" style="text-align:center;">

					<h:panelGrid style="margin:auto;">

						<p:dataTable
							value="#{searchSalesForNotificationsController.payers}" var="n"
							paginator="true" rows="5" id="payersTable">

							<p:column headerText="Nuic" width="100">
								<h:outputText value="#{n.nuicResponsible}"></h:outputText>
							</p:column>

							<p:column headerText="Nombres" width="100">
								<h:outputText value="#{n.firstnameResponsible}"></h:outputText>
							</p:column>

							<p:column headerText="Apellido Paterno" width="80">
								<h:outputText value="#{n.lastnamePaternalResponsible}">
								</h:outputText>
							</p:column>

							<p:column headerText="Apellido Materno" width="80">
								<h:outputText value="#{n.lastnameMaternalResponsible}">
								</h:outputText>
							</p:column>

							<p:column headerText="Correo" width="80">
								<h:outputText value="#{n.mail}">
								</h:outputText>
							</p:column>

							<p:column headerText="Dirección" width="80">
								<h:outputText value="#{n.address}"></h:outputText>
							</p:column>

							<p:column headerText="Provincia" width="80">
								<h:outputText value="#{n.province}"></h:outputText>
							</p:column>

							<p:column headerText="Departamento" width="80">
								<h:outputText value="#{n.department}"></h:outputText>
							</p:column>

							<p:column headerText="Distrito" width="80">
								<h:outputText value="#{n.district}"></h:outputText>
							</p:column>

							<p:column headerText="FECHA CREACIÓN" width="80">
								<h:outputText value="#{n.createdAt}">
									<f:convertDateTime pattern="dd/MM/yyyy hh:mm:ss a" />
								</h:outputText>
							</p:column>

							<p:column headerText="USUARIO CREACIÓN" width="80">
								<h:outputText value="#{n.createdBy.username}"></h:outputText>
							</p:column>




						</p:dataTable>

					</h:panelGrid>
				</p:outputPanel>
			</h:form>
		</p:dialog>


		<p:dialog header="Password Supervisor" widgetVar="passSuperDialog"
			showEffect="fade" hideEffect="fade" width="800" height="200">
			<h:form id="formPassSuper">
				<h:panelGrid style="margin:auto;">

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:messages id="messagesPassSuper"></p:messages>
					</h:panelGrid>

					<h:panelGrid columns="2">

						<p:outputLabel value="Password supervisor"></p:outputLabel>
						<p:password required="true"
							requiredMessage="Debe ingresar password supervisor"
							value="#{searchSalesForNotificationsController.passwordSupervisor}"></p:password>

					</h:panelGrid>

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:commandButton
							actionListener="#{searchSalesForNotificationsController.validate}"
							update=":formPassSuper:messagesPassSuper" value="Aceptar">
							<p:ajax event="dialogReturn" update=":form:searchTable"
								listener="#{searchSalesForNotificationsController.afterAddMaintenance}" />
						</p:commandButton>
					</h:panelGrid>
				</h:panelGrid>
			</h:form>

		</p:dialog>

		<p:dialog header="Crear Notificaciones"
			widgetVar="notificationsDialog" showEffect="fade" hideEffect="fade"
			width="800" height="200">
			<h:form id="formNotifications">
				<h:panelGrid style="margin:auto;">

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:messages id="messagesNotifications" showDetail="true"></p:messages>
					</h:panelGrid>

					<h:panelGrid columns="2">

						<p:outputLabel value="Ingrese fecha de envío"></p:outputLabel>
						<p:calendar required="true" pattern="dd/MM/yyyy" navigator="true"
							requiredMessage="Debe ingresar fecha de envío"
							value="#{searchSalesForNotificationsController.sendingAtForPhysicals}"></p:calendar>

					</h:panelGrid>

					<h:panelGrid style="margin:auto;text-align:center;">
						<p:commandButton
							actionListener="#{searchSalesForNotificationsController.createNotifications}"
							update=":formNotifications:messagesNotifications"
							value="Crear masivamente notificaciones">
						</p:commandButton>
					</h:panelGrid>
				</h:panelGrid>
			</h:form>

		</p:dialog>



	</ui:define>

</ui:composition>
</html>
